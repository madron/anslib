#!/bin/bash

# {{ ansible_managed }}

{% for backup in rdiff_backup_server_list %}
#-----------------------------------------------------------------------------
#
# {{ backup.host }}
#
ssh -o ConnectTimeout=2 -o BatchMode=yes -o StrictHostKeyChecking=no root@{{ backup.host }} true 2>> {{ rdiff_backup_server_dest }}/error_{{ backup.host }}.txt
status=$?
if [ $status -eq 0 ]; then

rdiff-backup --create-full-path --print-statistics {% for path in backup.excludes|default([]) %} --exclude {{ path }}{% endfor %} {% for path in backup.includes %} --include {{ path }}{% endfor %} --exclude / {{ backup.host }}::/ {{ rdiff_backup_server_dest }}/{{ backup.host }}/ >> {{ rdiff_backup_server_dest }}/stats_{{ backup.host }}.txt 2>> {{ rdiff_backup_server_dest }}/error_{{ backup.host }}.txt
{% for path in backup.includes %}
if [[ ! -d {{ rdiff_backup_server_dest }}/{{ backup.host }}/{{ path }} ]]; then
echo "backup '{{ path }}' directory on {{ backup.host }} doesn't exist" >> {{ rdiff_backup_server_dest }}/error_{{ backup.host }}.txt;
fi
{% endfor %}

rdiff-backup --remove-older-than {{ backup.retain_days|default(rdiff_backup_server_default_retain_days) }}D {{ rdiff_backup_server_dest }}/{{ backup.host }}/ >> {{ rdiff_backup_server_dest }}/warn_{{ backup.host }}.txt;
fi

{% endfor %}
