- name: os specific variables
  include_vars: "{{ ansible_lsb.id|lower() }}_{{ ansible_lsb.codename }}.yml"
  tags:
    - distribution


- name: set variables
  set_fact:
    distribution_container_backend: distribution-backend
    distribution_service_backend: dck-distribution-backend
    distribution_container_frontend: distribution-frontend
    distribution_service_frontend: dck-distribution-frontend
  tags:
    - distribution


- name: docker image distribution
  command: 'docker pull distribution/registry:{{ distribution_tag }}'
  tags:
    - distribution


- name: data and configurarion directories
  file:
    path: '{{ item }}'
    state: directory
    owner: root
    group: root
    mode: 0755
  with_items:
    - '/var/lib/container/{{ distribution_container_backend }}'
    - '/etc/container/{{ distribution_container_frontend }}'
  tags:
    - distribution


- name: upstart backend file
  template:
    src: upstart-backend.conf
    dest: '/etc/init/{{ distribution_service_backend }}.conf'
    mode: 0644
    owner: root
    group: root
    backup: yes
  register: upstart_backend
  tags:
    - distribution


- name: service backend restarted
  service:
    name: '{{ distribution_service_backend }}'
    state: restarted
  when: upstart_backend.changed
  tags:
    - distribution


- name: service backend started
  service:
    name: '{{ distribution_service_backend }}'
    state: started
  tags:
    - distribution


- name: upstart frontend file
  template:
    src: upstart-frontend.conf
    dest: '/etc/init/{{ distribution_service_frontend }}.conf'
    mode: 0644
    owner: root
    group: root
    backup: yes
  register: upstart_frontend
  tags:
    - distribution


- name: service frontend restarted
  service:
    name: '{{ distribution_service_frontend }}'
    state: restarted
  when: upstart_frontend.changed
  tags:
    - distribution


- name: service frontend started
  service:
    name: '{{ distribution_service_frontend }}'
    state: started
  tags:
    - distribution
