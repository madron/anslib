# https://uwsgi-docs.readthedocs.org/en/latest/WSGIquickstart.html
# https://uwsgi-docs.readthedocs.org/en/latest/Emperor.html

# Setting up Nginx + uWSGI Emperor to host Python applications on Ubuntu 12.04
# http://www.collabspot.com/2012/08/14/setting-up-nginx-uwsgi-python-ubuntu-12-04/


- name: Role uwsgi_emperor - requirements
  apt: name={{ item }} state=present
  with_items:
  - build-essential
  - python-dev
  - python-pip

- name: Role uwsgi_emperor - git-core
  apt: >
    name=git-core
    state=present
  when: ansible_distribution_version < '12.04'

- name: Role uwsgi_emperor - pip
  pip: >
    name=pip
    state=latest
    use_mirrors=no
  when: ansible_distribution_version < '12.04'

- name: Role uwsgi_emperor - git
  apt: name=git state=present
  when: ansible_distribution_version >= '12.04'

- name: Role uwsgi_emperor - uwsgi package
  pip: name=uwsgi version=1.9.18.2

- name: Role uwsgi_emperor - uwsgitop package
  pip: name='git+https://github.com/madron/uwsgitop.git@769e875fafbde6e1c22235ff837a6cea2b6e83be#egg=uwsgitop'

- name: Role uwsgi_emperor - directories
  file: path={{ item }} state=directory owner=root group=root mode=0755
  with_items:
  - /var/log/uwsgi

- name: Role uwsgi_emperor - supervisor configuration
  template: src=uwsgi-emperor.conf dest=/etc/supervisor/conf.d/uwsgi-emperor.conf
  register: supervisor_configuration

- name: Role uwsgi_emperor - supervisor reread
  command: supervisorctl reload
  when: supervisor_configuration.changed

- name: Role uwsgi_emperor - restart uwsgi-emperor
  supervisorctl: name=uwsgi-emperor state=restarted
  when: supervisor_configuration.changed

- name: Role uwsgi_emperor - start uwsgi-emperor
  supervisorctl: name=uwsgi-emperor state=started
