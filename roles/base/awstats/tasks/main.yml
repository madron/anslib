- name: os specific variables
  include_vars: "{{ ansible_lsb.id|lower() }}_{{ ansible_lsb.codename }}.yml"
  tags:
    - awstats


- include: packages_debian.yml
  when: ansible_os_family == 'Debian'
  tags:
    - awstats


- name: create /etc/logrotate.d/httpd-prerotate directory
  file: >
    path=/etc/logrotate.d/httpd-prerotate
    state=directory
    mode=0755
    owner=root
    group=root
  tags:
    - awstats


- name: awstats data dir
  file: >
    path=/var/lib/awstats/{{ awstats_code }}
    state=directory
    mode=0750
    owner=www-data
    group=www-data
  tags:
    - awstats


- name: awstats.conf
  template: >
    src=awstats.conf.j2
    dest=/etc/awstats/awstats.{{ awstats_code }}.conf
    mode=0755
    owner=root
    group=root
  tags:
    - awstats


- name: cron daily
  template: >
    src=cron_daily.j2
    dest=/etc/cron.daily/awstats_{{ awstats_code }}
    mode=0755
    owner=root
    group=root
  tags:
    - awstats


- name: httpd-prerotate script
  file: >
    src=/etc/cron.daily/awstats_{{ awstats_code }}
    dest=/etc/logrotate.d/httpd-prerotate/awstats_{{ awstats_code }}
    state=link
    force=yes
    owner=root
    group=root
  tags:
    - awstats


- name: nginx config
  template: >
    src=site.j2
    dest=/etc/nginx/sites-available/awstats.conf
    mode=0664
    owner=root
    group=root
  notify: reload nginx
  tags:
    - awstats


- name: nginx config symlink
  file: >
    src=/etc/nginx/sites-available/awstats.conf
    dest=/etc/nginx/sites-enabled/awstats.conf
    state=link
    force=yes
    owner=root
    group=root
  notify: reload nginx
  tags:
    - awstats
