- name: Role nginx - ppa repository
  apt_repository: >
    repo=ppa:ubuntu-lxc/stable
    state=present
  tags:
    - lxc-host

- name: required packages
  apt: >
    name={{ item }}
    state=latest
  with_items:
    - cgroup-bin
    - lxc
    - lxc-templates
    - python3-lxc
  tags:
    - lxc-host

- name: lxc.conf
  template: >
    src=default.conf
    dest=/etc/lxc/default.conf
    mode=0644
    owner=root
    group=root
  tags:
    - lxc-host

- name: add python-minimal package to debian template
  lineinfile: >
    dest=/usr/share/lxc/templates/lxc-debian
    insertafter='^ifupdown,'
    line='python-minimal,\'
    backup=yes
  register: debian_template
  tags:
    - lxc-host

- name: remove debian cache cirectory
  file: >
    path=/var/cache/lxc/debian
    state=absent
  when: debian_template.changed
  tags:
    - lxc-host

# Generate a random mac address (ensure that first number is even)
# openssl rand -hex 6 | sed 's/\(..\)/\1:/g; s/.$//'

# Clone a vm
# lxc-clone -o play_fresh -n play1
#
# Destroy and recreate a vm from scratch
# lxc-kill -n play1; lxc-destroy -n play1; lxc-create -t ubuntu -n play1
#
# Regen ansible config and then start the vm
# lxc-start -d -n play1


- { include: instance_remove.yml }

- { include: instance.yml }
