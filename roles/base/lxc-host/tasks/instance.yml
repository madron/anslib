- name: create vm
  command: >
    lxc-create -n {{ item.name }} -t {{ item.distribution }} -- --release {{ item.release }}
    creates=/var/lib/lxc/{{ item.name }}
  register: create_vm
  with_items: lxc_host_instances
  tags:
    - lxc-host
    - lxc-host-instance
    - lxc-host-instance-create

- name: config
  template: >
    src=vm.conf
    dest=/var/lib/lxc/{{ item.name }}/config
    mode=0644
    owner=root
    group=root
  register: config
  with_items: lxc_host_instances
  tags:
    - lxc-host
    - lxc-host-instance
    - lxc-host-instance-create

- name: authorized keys
  authorized_key: >
    path=/var/lib/lxc/{{ item.0.name }}/rootfs/root/.ssh/authorized_keys
    user=root
    key="{{ item.1 }}"
  with_nested:
    - lxc_host_instances
    - lxc_host_authorized_keys
  tags:
    - lxc-host
    - lxc-host-instance
    - lxc-host-instance-create

- name: remove resolvconf tail
  file: >
    path=/var/lib/lxc/{{ item.name }}/rootfs/etc/resolvconf/resolv.conf.d/tail
    state=absent
  with_items: lxc_host_instances
  tags:
    - lxc-host
    - lxc-host-instance
    - lxc-host-instance-create

- name: stop vm
  command: lxc-stop -t 15 -n {{ item.0.item.name }}
  with_together:
    - create_vm.results
    - config.results
  when: item.1.changed and not item.0.changed
  ignore_errors: yes
  tags:
    - lxc-host
    - lxc-host-instance
    - lxc-host-instance-create

- name: start vm
  command: lxc-start -d -n {{ item.0.item.name }}
  with_together:
    - create_vm.results
    - config.results
  when: item.0.changed or item.1.changed
  tags:
    - lxc-host
    - lxc-host-instance
    - lxc-host-instance-create
