- name: os specific variables
  include_vars: "{{ ansible_lsb.id|lower() }}_{{ ansible_lsb.codename }}.yml"
  tags: nginx


- include: packages_debian.yml
  when: ansible_os_family == 'Debian'
  tags: nginx


- name: nginx.conf
  template:
    src: nginx.conf.j2
    dest: /etc/nginx/nginx.conf
    mode: 0644
    owner: root
    group: root
  notify: reload nginx
  tags: nginx


- name: disable default site config
  file:
    path: /etc/nginx/sites-enabled/default
    state: absent
  notify: reload nginx
  tags: nginx


- name: disable fallback site on listed ports
  template:
    src: default_port.conf.j2
    dest: /etc/nginx/sites-available/default_{{ item }}.conf
    mode: 0644
    owner: root
    group: root
  with_items: nginx_ports
  notify: reload nginx
  tags: nginx


- name: disable fallback site on listed ports - symlink
  file:
    src: /etc/nginx/sites-available/default_{{ item }}.conf
    dest: /etc/nginx/sites-enabled/default_{{ item }}.conf
    state: link
    force: yes
    owner: root
    group: root
  with_items: nginx_ports
  notify: reload nginx
  tags: nginx


- name: certificate directory
  file:
    path: '{{ nginx_certificates_directory }}'
    state: directory
    mode: 0755
    owner: root
    group: root
  tags: nginx


- name: certificate
  copy:
    src: '{{ inventory_dir }}/files/nginx_certificates/{{ item }}/certificate'
    dest: '{{ nginx_certificates_directory }}/{{ item }}.crt'
    mode: 0644
    owner: root
    group: root
  with_items: nginx_certificates
  tags: nginx


- name: certificate key
  copy:
    src: '{{ inventory_dir }}/files/nginx_certificates/{{ item }}/certificate_key'
    dest: '{{ nginx_certificates_directory }}/{{ item }}.key'
    mode: 0644
    owner: root
    group: root
  with_items: nginx_certificates
  tags: nginx


- name: proxy pass - sites-available
  template:
    src: proxy_pass.conf.j2
    dest: /etc/nginx/sites-available/{{ item.server_name }}.conf
    mode: 0644
    owner: root
    group: root
  with_items: nginx_proxy_pass
  notify: reload nginx
  tags: nginx


- name: proxy pass - sites-enabled
  file:
    src: /etc/nginx/sites-available/{{ item.server_name }}.conf
    dest: /etc/nginx/sites-enabled/{{ item.server_name }}.conf
    state: link
    force: yes
    owner: root
    group: root
  with_items: nginx_proxy_pass
  notify: reload nginx
  tags: nginx


- name: start server
  service:
    name: nginx
    state: started
  tags: nginx
