# {{ ansible_managed }}
{% set REDIS = 'sentry-redis' %}
{% set REDIS_AMBASSADOR = REDIS + '-ambassador' %}
{% set POSTGRES = 'sentry-postgres' %}
{% set POSTGRES_DATA = POSTGRES + '-data' %}
{% set POSTGRES_AMBASSADOR = POSTGRES + '-ambassador' %}
{% set WORKER = 'sentry-worker' %}


description "sentry containers"
author "Massimiliano Ravelli <m.ravelli@mastervoice.it>"

### Syncdb
# docker run -it --rm --link sentry-postgres-ambassador:postgres sentry:6.4 sentry syncdb

### Create superuser
# docker run -it --rm --link sentry-postgres-ambassador:postgres sentry:6.4 sentry createsuperuser --username admin --email admin@example.com

pre-start script
    # POSTGRES_DATA
    if ! docker inspect {{ POSTGRES_DATA }} > /dev/null 2>&1; then
        env INIT_DATA='true'
        /usr/bin/docker create \
            --name {{ POSTGRES_DATA }} \
            --hostname {{ POSTGRES_DATA }} \
            --volume /var/lib/postgresql/data \
            busybox
    fi
    # REDIS_AMBASSADOR
    if ! docker inspect {{ REDIS_AMBASSADOR }} > /dev/null 2>&1; then
        /usr/bin/docker run \
            -d \
            --restart="always" \
            --name {{ REDIS_AMBASSADOR }} \
            --hostname {{ REDIS_AMBASSADOR }} \
            --volume /var/run/docker.sock:/var/run/docker.sock \
            cpuguy83/docker-grand-ambassador --name {{ REDIS }}
    fi
    # REDIS
    if ! docker inspect {{ REDIS }} > /dev/null 2>&1; then
        /usr/bin/docker run \
            -d \
            --restart="always" \
            --name {{ REDIS }} \
            --hostname {{ REDIS }} \
            redis:2.8 redis-server
    fi
    # POSTGRES_AMBASSADOR
    if ! docker inspect {{ POSTGRES_AMBASSADOR }} > /dev/null 2>&1; then
        /usr/bin/docker run \
            -d \
            --restart="always" \
            --name {{ POSTGRES_AMBASSADOR }} \
            --hostname {{ POSTGRES_AMBASSADOR }} \
            --volume /var/run/docker.sock:/var/run/docker.sock \
            cpuguy83/docker-grand-ambassador --name {{ POSTGRES }}
    fi
    # POSTGRES
    if ! docker inspect {{ POSTGRES }} > /dev/null 2>&1; then
        /usr/bin/docker run \
            -d \
            --restart="always" \
            --name {{ POSTGRES }} \
            --hostname {{ POSTGRES }} \
            --volumes-from {{ POSTGRES_DATA }} \
            postgres:9.4
    fi
    # WORKER
    if ! docker inspect {{ WORKER }} > /dev/null 2>&1; then
        /usr/bin/docker run \
            -d \
            --restart="always" \
            --name {{ WORKER }} \
            --hostname {{ WORKER }} \
            --link {{ POSTGRES_AMBASSADOR }}:postgres \
            --link {{ REDIS_AMBASSADOR }}:redis \
            --publish {{ sentry_port }}:9000 \
            --env=ALLOWED_HOSTS={{ sentry_allowed_hosts }} \
            --env=SENTRY_URL_PREFIX={{ sentry_url_prefix }} \
            --env=EMAIL_HOST={{ sentry_email_host }} \
            --env=EMAIL_HOST_PASSWORD={{ sentry_email_host_password }} \
            --env=EMAIL_HOST_USER={{ sentry_email_host_user }} \
            --env=EMAIL_PORT={{ sentry_email_port }} \
            --env=EMAIL_USE_TLS={{ sentry_email_use_tls }} \
            --env=SERVER_EMAIL={{ sentry_server_email }} \
            mtek/sentry-worker
    fi
end script

post-stop script
    if docker inspect {{ WORKER }} > /dev/null 2>&1; then
        /usr/bin/docker rm -fv {{ WORKER }}
    fi
    if docker inspect {{ POSTGRES }} > /dev/null 2>&1; then
        /usr/bin/docker rm -fv {{ POSTGRES }}
    fi
    if docker inspect {{ REDIS }} > /dev/null 2>&1; then
        /usr/bin/docker rm -fv {{ REDIS }}
    fi
end script
