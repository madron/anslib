# {{ ansible_managed }}
{% set ETCD = 'etcd' %}
{% set ETCD_DATA = ETCD + '-data' %}
{% set ETCD_AMBASSADOR = ETCD + '-ambassador' %}


description "etcd containers"
author "Massimiliano Ravelli <m.ravelli@mastervoice.it>"


pre-start script
    # ETCD_DATA
    if ! docker inspect {{ ETCD_DATA }} > /dev/null 2>&1; then
        /usr/bin/docker create \
            --name {{ ETCD_DATA }} \
            --hostname {{ ETCD_DATA }} \
            --volume /data \
            busybox
    fi
    # ETCD_AMBASSADOR
    if ! docker inspect {{ ETCD_AMBASSADOR }} > /dev/null 2>&1; then
        /usr/bin/docker run \
            -d \
            --restart="always" \
            --name {{ ETCD_AMBASSADOR }} \
            --hostname {{ ETCD_AMBASSADOR }} \
            --volume /var/run/docker.sock:/var/run/docker.sock \
            cpuguy83/docker-grand-ambassador --name {{ ETCD }}
    fi
    # ETCD
    if ! docker inspect {{ ETCD }} > /dev/null 2>&1; then
        /usr/bin/docker run \
            -d \
            --restart="always" \
            --name {{ ETCD }} \
            --hostname {{ ETCD }} \
            --volumes-from {{ ETCD_DATA }} \
            --publish {{ etcd_client_port }}:4001 \
            --publish {{ etcd_peer_port }}:7001 \
            elcolio/etcd:latest
    fi
end script

post-stop script
    if docker inspect {{ ETCD }} > /dev/null 2>&1; then
        /usr/bin/docker rm -fv {{ ETCD }}
    fi
end script
