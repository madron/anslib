# {{ ansible_managed }}
{% set REGISTRY = registry_prefix ~ '-server' %}
{% set REGISTRY_AMBASSADOR = registry_prefix ~ '-ambassador' %}
{% set REGISTRY_DATA = registry_prefix ~ '-data' %}
{% set NGINX = registry_nginx_container_name %}


description "{{ registry_prefix }} containers"
author "Massimiliano Ravelli <m.ravelli@mastervoice.it>"


pre-start script
{% if registry_nginx_port %}
    # REGISTRY_AMBASSADOR
    if ! docker inspect {{ REGISTRY_AMBASSADOR }} > /dev/null 2>&1; then
        /usr/bin/docker run \
            -d \
            --restart="always" \
            --name {{ REGISTRY_AMBASSADOR }} \
            --hostname {{ REGISTRY_AMBASSADOR }} \
            --volume /var/run/docker.sock:/var/run/docker.sock \
            cpuguy83/docker-grand-ambassador --name {{ REGISTRY }}
    fi
    # NGINX
    if ! docker inspect {{ NGINX }} > /dev/null 2>&1; then
        /usr/bin/docker run \
            -d \
            --restart="always" \
            --name {{ NGINX }} \
            --hostname {{ NGINX }} \
            --volume /etc/container/{{ NGINX }}:/etc/nginx/conf.d \
            --link {{ REGISTRY_AMBASSADOR }}:registry \
            --publish {{ registry_nginx_port }}:80 \
            nginx:{{ registry_nginx_tag }}
    fi
{% endif %}
    # REGISTRY_DATA
    if ! docker inspect {{ REGISTRY_DATA }} > /dev/null 2>&1; then
        /usr/bin/docker create \
            --name {{ REGISTRY_DATA }} \
            --hostname {{ REGISTRY_DATA }} \
{% if registry_data_dir %}
            --volume {{ registry_data_dir }}:/data \
{% else %}
            --volume /data \
{% endif %}
            busybox
    fi
    # REGISTRY
    if ! docker inspect {{ REGISTRY }} > /dev/null 2>&1; then
        /usr/bin/docker run \
            -d \
            --restart="always" \
            --name {{ REGISTRY }} \
            --hostname {{ REGISTRY }} \
            --volumes-from {{ REGISTRY_DATA }} \
{% if registry_port %}
            --publish {{ registry_port }}:5000 \
{% endif %}
{% for key in registry_options %}
            --env="{{ key }}={{ registry_options[key] }}" \
{% endfor %}
            --env="STORAGE_PATH=/data" \
            registry:{{ registry_tag }}
    fi
end script

post-stop script
    if docker inspect {{ NGINX }} > /dev/null 2>&1; then
        /usr/bin/docker rm -fv {{ NGINX }}
    fi
    if docker inspect {{ REGISTRY }} > /dev/null 2>&1; then
        /usr/bin/docker rm -fv {{ REGISTRY }}
    fi
end script
