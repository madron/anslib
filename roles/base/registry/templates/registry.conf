# {{ ansible_managed }}

upstream docker-registry {
  server registry:5000;
}


server {
  listen 80;

  client_max_body_size 0; # disable any limits to avoid HTTP 413 for large image uploads

  # required to avoid HTTP 411: see Issue #1486 (https://github.com/docker/docker/issues/1486)
  chunked_transfer_encoding on;


  location / {
    limit_except GET {
{% for subnet in registry_write_subnets %}
      allow  {{ subnet }};
{% endfor %}
      deny    all;
    }

{% for subnet in registry_read_subnets %}
    allow  {{ subnet }};
{% endfor %}
{% for subnet in registry_write_subnets %}
    allow  {{ subnet }};
{% endfor %}
    deny    all;

    include               conf.d/registry.include;
  }
}