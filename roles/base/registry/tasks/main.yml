- name: os specific variables
  include_vars: "{{ ansible_lsb.id|lower() }}_{{ ansible_lsb.codename }}.yml"
  tags:
    - registry


- name: set variables
  set_fact:
    registry_nginx_container_name: '{{ registry_prefix }}-nginx'
  tags:
    - registry


- name: /etc/container directory
  file:
    path: '/etc/container/{{ registry_nginx_container_name }}'
    state: directory
    mode: 0755
    owner: root
    group: root
  when: registry_nginx_port
  tags:
    - registry


- name: nginx configuration files
  template:
    src: '{{ item }}'
    dest: '/etc/container/{{ registry_nginx_container_name }}/'
    mode: 0644
    owner: root
    group: root
  notify: 'reload {{ registry_nginx_container_name }}'
  when: registry_nginx_port
  with_items:
    - registry.conf
    - registry.include
  tags:
    - registry


- name: htpasswd file
  command: touch /etc/container/{{ registry_nginx_container_name }}/registry.htpasswd
  args:
    creates: /etc/container/{{ registry_nginx_container_name }}/registry.htpasswd
  when: registry_nginx_port
  tags:
    - registry


- name: upstart file
  template:
    src: container.conf
    dest: '/etc/init/{{ registry_prefix }}.conf'
    mode: 0644
    owner: root
    group: root
  notify: 'restart {{ registry_prefix }}'
  tags:
    - registry


- name: registry service
  service:
    name: '{{ registry_prefix }}'
    state: started
  tags:
    - registry
