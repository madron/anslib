- name: repository key
  apt_key:
    url: https://apt.dockerproject.org/gpg
    id: 2C52609D
    state: present
  tags:
    - docker
    - docker-engine


- name: repository
  apt_repository:
    repo: 'deb https://apt.dockerproject.org/repo {{ ansible_lsb.id|lower() }}-{{ ansible_lsb.codename }} {{ docker_engine_repository }}'
    state: present
  tags:
    - docker
    - docker-engine


- name: required packages
  apt:
    name: '{{ item }}'
    state: latest
  with_items: '{{ docker_engine_packages }}'
  tags:
    - docker
    - docker-engine


- name: docker-engine package
  apt:
    name: 'docker-engine={{ docker_engine_version }}-0~{{ ansible_lsb.codename }}'
    state: present
  tags:
    - docker
    - docker-engine


- name: held packages
  command: apt-mark showhold
  register: held_packages
  when: docker_engine_version_hold
  changed_when: false
  tags:
    - docker
    - docker-engine
    - docker-engine-hold


- name: docker-engine version hold
  command: apt-mark hold docker-engine
  when: docker_engine_version_hold and "docker-engine" not in held_packages.stdout
  tags:
    - docker
    - docker-engine
    - docker-engine-hold


- name: default docker
  template:
    src: default_docker.j2
    dest: /etc/default/docker
    mode: 0644
    owner: root
    group: root
    backup: true
  register: default
  tags:
    - docker
    - docker-engine


- name: service restarted
  service:
    name: docker
    state: restarted
  when: default.changed
  tags:
    - docker
    - docker-engine


- name: service started
  service:
    name: docker
    state: started
  tags:
    - docker
    - docker-engine
