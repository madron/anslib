- name: node list
  command: 'docker node ls -f name={{ inventory_hostname }}'
  register: node_list
  changed_when: false
  failed_when: node_list.rc > 1
  when: docker_swarm_role == 'manager'
  tags:
    - docker
    - docker-swarm


- name: swarm init
  command: 'docker swarm init --listen-addr {{ docker_swarm_manager_host|default(ansible_host) }}:{{ docker_swarm_manager_port }}'
  when: docker_swarm_role == 'manager' and ( node_list.stdout_lines|length() == 1 or node_list.rc == 1 )
  tags:
    - docker
    - docker-swarm


- name: docker info
  shell: 'docker info | grep "Swarm: active"'
  register: docker_info
  changed_when: false
  failed_when: docker_info.rc > 1
  when: docker_swarm_role == 'worker'
  tags:
    - docker
    - docker-swarm


- name: swarm join
  command: 'docker swarm join {{ docker_swarm_manager_host|default(hostvars[docker_swarm_manager].ansible_host) }}:{{ docker_swarm_manager_port }}'
  when: docker_swarm_role == 'worker' and ( docker_info.stdout_lines|length() == 0  or docker_info.rc == 1 )
  tags:
    - docker
    - docker-swarm
