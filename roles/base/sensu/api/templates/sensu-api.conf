# {{ ansible_managed }}
{% set RABBITMQ_AMBASSADOR_NAME = sensu_prefix + '_sensu_rabbitmq_ambassador' %}
{% set REDIS_AMBASSADOR_NAME = sensu_prefix + '_sensu_redis_ambassador' %}
{% set CONTAINER_NAME = sensu_prefix + '_sensu_api' %}
{% set AMBASSADOR_NAME = CONTAINER_NAME + '_ambassador' %}

description "{{ CONTAINER_NAME }} container"
author "Massimiliano Ravelli <m.ravelli@mastervoice.it>"

pre-start script
    # Ambassador
    if ! docker inspect {{ AMBASSADOR_NAME }} > /dev/null 2>&1; then
        /usr/bin/docker run \
            -d \
            --restart="always" \
            --name {{ AMBASSADOR_NAME }} \
            --hostname {{ AMBASSADOR_NAME }} \
            --volume /var/run/docker.sock:/var/run/docker.sock \
            cpuguy83/docker-grand-ambassador --name {{ CONTAINER_NAME }}
    fi
    # Container
    if ! docker inspect {{ CONTAINER_NAME }} > /dev/null 2>&1; then
        /usr/bin/docker run \
            -d \
            --restart="always" \
            --name {{ CONTAINER_NAME }} \
            --hostname {{ CONTAINER_NAME }} \
            --volume {{ sensu_api_etc_base_dir }}/{{ sensu_prefix }}/ssl:/etc/sensu/ssl:ro \
            --publish {{ sensu_api_port }}:4567 \
            --link={{ RABBITMQ_AMBASSADOR_NAME }}:rabbitmq \
            --link={{ REDIS_AMBASSADOR_NAME }}:redis \
            --env=RABBITMQ_PASSWORD={{ sensu_rabbitmq_password }} \
            mtek/sensu_api
    fi
end script

post-stop script
    /usr/bin/docker rm -fv {{ CONTAINER_NAME }}
end script
