- name: os specific variables
  include_vars: "{{ ansible_lsb.id|lower() }}_{{ ansible_lsb.codename }}.yml"
  when: ansible_distribution != 'MacOSX'
  tags:
    - openssl-ca


- include_tasks: debian.yml
  when: ansible_os_family == 'Debian'
  tags:
    - openssl-ca


- name: certs directory
  file:
    path: '{{ openssl_ca_base_dir }}/{{ openssl_ca }}/{{ item }}'
    state: directory
    mode: 0755
  with_items:
    - certs
    - newcerts
  tags:
    - openssl-ca


- name: private directory
  file:
    path: '{{ openssl_ca_base_dir }}/{{ openssl_ca }}/private'
    state: directory
    mode: 0700
  tags:
    - openssl-ca


- name: openssl.cnf
  template:
    src: openssl.cnf
    dest: '{{ openssl_ca_base_dir }}/{{ openssl_ca }}/'
    mode: 0644
  tags:
    - openssl-ca


- name: index.txt
  command: 'touch {{ item }}'
  args:
    chdir: '{{ openssl_ca_base_dir }}/{{ openssl_ca }}'
    creates: '{{ openssl_ca_base_dir }}/{{ openssl_ca }}/{{ item }}'
  with_items:
    - index.txt
    - index.txt.old
    - index.txt.attr
    - index.txt.attr.old
  tags:
    - openssl-ca


- name: serial
  shell:  "echo '01' > serial"
  args:
    chdir: '{{ openssl_ca_base_dir }}/{{ openssl_ca }}'
    creates: '{{ openssl_ca_base_dir }}/{{ openssl_ca }}/serial'
  tags:
    - openssl-ca


- name: serial.old
  command: touch serial.old
  args:
    chdir: '{{ openssl_ca_base_dir }}/{{ openssl_ca }}'
    creates: '{{ openssl_ca_base_dir }}/{{ openssl_ca }}/serial.old'
  tags:
    - openssl-ca


- name: revoked.crl
  command: touch revoked.crl
  args:
    chdir: '{{ openssl_ca_base_dir }}/{{ openssl_ca }}'
    creates: '{{ openssl_ca_base_dir }}/{{ openssl_ca }}/revoked.crl'
  tags:
    - openssl-ca


- name: ca private key
  command: "openssl genrsa -out private/ca.key {{ openssl_ca_default_days }}"
  args:
    chdir: '{{ openssl_ca_base_dir }}/{{ openssl_ca }}'
    creates: '{{ openssl_ca_base_dir }}/{{ openssl_ca }}/private/ca.key'
  tags:
    - openssl-ca


- name: ca private key permission
  file:
    path: '{{ openssl_ca_base_dir }}/{{ openssl_ca }}/private/ca.key'
    state: file
    mode: 0600
  tags:
    - openssl-ca


- name: ca certificate
  command: "openssl req -config openssl.cnf -batch -new -x509 -subj '/CN={{ openssl_ca }}' -key private/ca.key -out certs/ca.crt"
  args:
    chdir: '{{ openssl_ca_base_dir }}/{{ openssl_ca }}'
    creates: '{{ openssl_ca_base_dir }}/{{ openssl_ca }}/certs/ca.crt'
  tags:
    - openssl-ca


- name: server private key and csr
  # -subj '/CN={{ item.name }}/O=My Company Name LTD./C=US'
  command: "openssl req -config openssl.cnf -batch -new -nodes -subj '/CN={{ item.cn }}' -keyout private/{{ item.name }}.key -out private/{{ item.name }}.csr -days {{ openssl_ca_default_days }}"
  args:
    chdir: '{{ openssl_ca_base_dir }}/{{ openssl_ca }}'
    creates: '{{ openssl_ca_base_dir }}/{{ openssl_ca }}/private/{{ item.name }}.key'
  with_items: openssl_ca_servers
  tags:
    - openssl-ca


- name: server private key permission
  file:
    path: '{{ openssl_ca_base_dir }}/{{ openssl_ca }}/private/{{ item.name }}.key'
    state: file
    mode: 0600
  with_items: openssl_ca_servers
  tags:
    - openssl-ca


- name: server certificate
  command: 'openssl ca -config openssl.cnf -batch -policy {{ openssl_ca_policy }}  -out certs/{{ item.name }}.crt -infiles private/{{ item.name }}.csr'
  args:
    chdir: '{{ openssl_ca_base_dir }}/{{ openssl_ca }}'
    creates: '{{ openssl_ca_base_dir }}/{{ openssl_ca }}/certs/{{ item.name }}.crt'
  with_items: openssl_ca_servers
  tags:
    - openssl-ca


- name: server certificate revocation
  shell: 'openssl ca -config openssl.cnf -batch -revoke certs/{{ item }}.crt -gencrl -out revoked.crl && touch private/{{ item }}.revoked'
  args:
    chdir: '{{ openssl_ca_base_dir }}/{{ openssl_ca }}'
    creates: '{{ openssl_ca_base_dir }}/{{ openssl_ca }}/private/{{ item }}.revoked'
  with_items: openssl_ca_revoked_servers
  tags:
    - openssl-ca
