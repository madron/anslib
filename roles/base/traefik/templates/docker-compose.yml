version: '3.1'

services:
  proxy:
    image: traefik:{{ version }}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /dev/null:/traefik.toml
    command: {{ traefik_options }}
{% if traefik_global_networks %}
    networks:
{% for network in traefik_global_networks %}
      - {{ network }}
{% endfor %}
{% endif %}
    deploy:
      replicas: {{ replicas }}
      placement:
        constraints:
{% for constraint in traefik_constraints %}
          - {{ constraint }}
{% endfor %}
{% if publish_host %}
      labels:
        - "traefik.port=8080"
        - "traefik.docker.network=global_proxy"
        - "traefik.frontend.rule=Host:{{ publish_host }}"
{% endif %}


networks:
{% for network in traefik_global_networks %}
  {{ network }}:
    external: true
{% endfor %}
