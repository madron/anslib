- name: binary list
  set_fact:
    binary_list:
       - bridge
       - dhcp
       - flannel
       - host-device
       - host-local
       - ipvlan
       - loopback
       - macvlan
       - portmap
       - ptp
       - sample
       - tuning
       - vlan

- name: binary directory
  file:
    path: /opt/kubernetes/cni-{{ k8s_cni_release }}
    state: directory
    owner: root
    group: root
    mode: 0755

- name: download
  unarchive:
    src: 'https://github.com/containernetworking/plugins/releases/download/{{ k8s_cni_release }}/cni-plugins-amd64-{{ k8s_cni_release }}.tgz'
    dest: /opt/kubernetes/cni-{{ k8s_cni_release }}
    remote_src: yes


- name: symlink
  file:
    src: '/opt/kubernetes/cni-{{ k8s_cni_release }}/{{ item }}'
    dest: '/opt/bin/{{ item }}'
    state: link
    owner: root
    group: root
  with_items: '{{ binary_list }}'
  register: binary


# - name: ssl keys
#   copy:
#     src: '{{ k8s_certs_dir }}/{{ item }}'
#     dest: /etc/kubernetes/ssl/
#     owner: root
#     group: root
#     mode: 0600
#   with_items:
#     - 'node-{{ inventory_hostname }}.key'
#   register: keys
#   tags:
#     - k8s
#     - k8s-kubeadm
#     - k8s-kubeadm-service


# - name: ssl certs
#   copy:
#     src: '{{ k8s_certs_dir }}/{{ item }}'
#     dest: /etc/kubernetes/ssl/
#     owner: root
#     group: root
#     mode: 0644
#   with_items:
#     - 'ca.crt'
#     - 'node-{{ inventory_hostname }}.crt'
#   register: certs
#   tags:
#     - k8s
#     - k8s-kubeadm
#     - k8s-kubeadm-service


# - name: /etc/kubernetes/kubeadm.kubeconfig.yml
#   template:
#     src: kubeadm.kubeconfig.yml
#     dest: /etc/kubernetes/kubeadm.kubeconfig.yml
#     mode: 0644
#     owner: root
#     group: root
#   register: kubeconfig
#   tags:
#     - k8s
#     - k8s-kubeadm
#     - k8s-kubeadm-service


# - name: /etc/kubernetes/kubeadm.config.yml
#   template:
#     src: kubeadm.config.yml
#     dest: /etc/kubernetes/kubeadm.config.yml
#     mode: 0644
#     owner: root
#     group: root
#   register: config
#   tags:
#     - k8s
#     - k8s-kubeadm
#     - k8s-kubeadm-service


# - name: /etc/systemd/system/kubeadm.service
#   template:
#     src: kubeadm.service
#     dest: /etc/systemd/system/kubeadm.service
#     mode: 0644
#     owner: root
#     group: root
#     backup: yes
#   register: systemd
#   tags:
#     - k8s
#     - k8s-kubeadm
#     - k8s-kubeadm-service


# - name: restart service
#   systemd:
#     name: kubeadm
#     state: restarted
#     daemon_reload: yes
#   when: keys.changed or certs.changed or kubeconfig.changed or config.changed or systemd.changed
#   tags:
#     - k8s
#     - k8s-kubeadm
#     - k8s-kubeadm-service


# - name: start service
#   systemd:
#     name: kubeadm
#     enabled: yes
#     state: started
#   tags:
#     - k8s
#     - k8s-kubeadm
#     - k8s-kubeadm-service
