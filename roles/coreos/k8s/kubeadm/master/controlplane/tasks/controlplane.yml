- name: kubeconfig all
  command: /opt/bin/kubeadm alpha phase kubeconfig all --config /etc/kubernetes/kubeadm-config.yaml
  args:
    creates: /etc/kubernetes/controller-manager.conf


- name: controlplane all
  command: /opt/bin/kubeadm alpha phase controlplane all --config /etc/kubernetes/kubeadm-config.yaml
  args:
    creates: /etc/kubernetes/manifests/kube-apiserver.yaml


- name: mark-master
  command: /opt/bin/kubeadm alpha phase mark-master --config /etc/kubernetes/kubeadm-config.yaml


- name: addon kube-proxy
  command: /opt/bin/kubeadm alpha phase addon kube-proxy --config /etc/kubernetes/kubeadm-config.yaml


- name: .kube directory
  file:
    path: /root/.kube
    state: directory
    owner: root
    group: root
    mode: 0700


- name: .kube/config
  file:
    src: /etc/kubernetes/admin.conf
    dest: /root/.kube/config
    state: link
    owner: root
    group: root


- name: install weave net
  debug:
    msg: 'kubectl apply -f https://cloud.weave.works/k8s/net?k8s-version={{ k8s_release }}'
