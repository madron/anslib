- name: required directories
  file:
    path: '{{ item }}'
    state: directory
    owner: root
    group: root
    mode: 0755
  with_items:
    - /etc/kubernetes/manifests
    - /etc/kubernetes/pki/etcd
    - /var/lib/etcd
  tags:
    - k8s
    - k8s-etcd


- name: certificates
  copy:
    src: '{{ k8s_pki_dir }}/etcd/{{ item.src }}'
    dest: '/etc/kubernetes/pki/etcd/{{ item.dest }}'
    owner: root
    group: root
    mode: '{{ item.mode }}'
  register: pki
  with_items:
    - { src: 'ca.crt', dest: 'ca.crt', mode: '0644' }
    - { src: 'healthcheck-client.key', dest: 'healthcheck-client.key', mode: '0600' }
    - { src: 'healthcheck-client.crt', dest: 'healthcheck-client.crt', mode: '0644' }
    - { src: 'peer-{{ inventory_hostname }}.key', dest: 'peer.key', mode: '0600' }
    - { src: 'peer-{{ inventory_hostname }}.crt', dest: 'peer.crt', mode: '0644' }
    - { src: 'server-{{ inventory_hostname }}.key', dest: 'server.key', mode: '0600' }
    - { src: 'server-{{ inventory_hostname }}.crt', dest: 'server.crt', mode: '0644' }
  tags:
    - k8s
    - k8s-etcd


- name: manifest /etc/kubernetes/manifests/etcd.yaml
  template:
    src: etcd.yaml
    dest: /etc/kubernetes/manifests/etcd.yaml
    mode: 0644
    owner: root
    group: root
  register: manifest
  tags:
    - k8s
    - k8s-etcd
