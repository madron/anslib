- name: systemd config
  set_fact:
    flannel_configs: [
      { path: /etc/flannel, name: options.env },
      { path: /etc/systemd/system/flanneld.service.d, name: 40-ExecStartPre-symlink.conf },
    ]
    docker_configs: [
      { path: /etc/systemd/system/docker.service.d, name: 40-flannel.conf },
    ]
  tags:
    - k8s-flannel


- name: create directories
  file:
    path: '{{ item.path }}'
    state: directory
    owner: root
    group: root
    mode: 0755
  with_items: '{{ flannel_configs + docker_configs }}'
  tags:
    - k8s-flannel


- name: flannel config files
  template:
    src: '{{ item.name }}'
    dest: '{{ item.path }}/{{ item.name }}'
    mode: 0644
    owner: root
    group: root
    backup: yes
  with_items: '{{ flannel_configs }}'
  register: flannel_config
  tags:
    - k8s-flannel


- name: docker config files
  template:
    src: '{{ item.name }}'
    dest: '{{ item.path }}/{{ item.name }}'
    mode: 0644
    owner: root
    group: root
    backup: yes
  with_items: '{{ docker_configs }}'
  register: docker_config
  tags:
    - k8s-flannel


- name: flanneld restart
  systemd:
    name: flanneld
    state: restarted
    daemon_reload: yes
  when: flannel_config.changed
  tags:
    - k8s-flannel


- name: docker restart
  systemd:
    name: docker
    state: restarted
    daemon_reload: yes
  when: docker_config.changed
  tags:
    - k8s-flannel
