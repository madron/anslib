- name: certificates
  copy:
    src: '{{ k8s_pki_dir }}/{{ item.src }}'
    dest: '/etc/kubernetes/pki/{{ item.dest }}'
    owner: root
    group: root
    mode: '{{ item.mode }}'
  register: pki
  with_items:
    - { src: 'ca.crt',                        dest: 'ca.crt',                       mode: '0644' }
    - { src: 'front-proxy-ca.crt',            dest: 'front-proxy-ca.crt',           mode: '0644' }
    - { src: 'front-proxy-client.crt',        dest: 'front-proxy-client.crt',       mode: '0644' }
    - { src: 'front-proxy-client.key',        dest: 'front-proxy-client.key',       mode: '0600' }
    - { src: 'sa.crt',                        dest: 'sa.crt',                       mode: '0644' }
    - { src: 'etcd/ca.crt',                   dest: 'etcd/ca.crt',                  mode: '0644' }
    - { src: 'apiserver-etcd-client.key',     dest: 'apiserver-etcd-client.key',    mode: '0600' }
    - { src: 'apiserver-etcd-client.crt',     dest: 'apiserver-etcd-client.crt',    mode: '0644' }
    - { src: 'apiserver-kubelet-client.crt',  dest: 'apiserver-kubelet-client.crt', mode: '0644' }
    - { src: 'apiserver-kubelet-client.key',  dest: 'apiserver-kubelet-client.key', mode: '0600' }
    - { src: 'apiserver-{{ inventory_hostname }}.key', dest: 'apiserver.key',       mode: '0600' }
    - { src: 'apiserver-{{ inventory_hostname }}.crt', dest: 'apiserver.crt',       mode: '0644' }
  tags:
    - k8s
    - k8s-kube-apiserver


- name: manifest /etc/kubernetes/manifests/kube-apiserver.yaml
  template:
    src: kube-apiserver.yml
    dest: /etc/kubernetes/manifests/kube-apiserver.yaml
    mode: 0644
    owner: root
    group: root
  register: manifest
  tags:
    - k8s
    - k8s-kube-apiserver
    - k8s-kube-apiserver-manifest
