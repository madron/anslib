- name: root ca
  include_tasks: ca.yml
  vars:
    name: ca
    subject: '/CN=kubernetes'
    dir: '{{ k8s_pki_dir }}/etcd'

- name: peer
  include_tasks: cert.yml
  vars:
    name: 'peer-{{ item }}'
    subject: '/CN={{ item }}'
    dir: '{{ k8s_pki_dir }}/etcd'
    ca_name: '{{ k8s_pki_dir }}/etcd/ca'
    extended_key_usage: 'TLS Web Server Authentication, TLS Web Client Authentication'
    alt_dns:
      - 'localhost'
      - '{{ item }}'
      - '{{ item }}.{{ k8s_domain }}'
    alt_ip:
      - '127.0.0.1'
      - '0:0:0:0:0:0:0:1'
      - '{{ hostvars[item].ansible_host }}'
  with_items: '{{ k8s_master_hosts }}'

- name: server
  include_tasks: cert.yml
  vars:
    name: 'server-{{ item }}'
    subject: '/CN={{ item }}'
    dir: '{{ k8s_pki_dir }}/etcd'
    ca_name: '{{ k8s_pki_dir }}/etcd/ca'
    extended_key_usage: 'TLS Web Server Authentication, TLS Web Client Authentication'
    alt_dns:
      - 'localhost'
      - '{{ item }}'
      - '{{ item }}.{{ k8s_domain }}'
    alt_ip:
      - '127.0.0.1'
      - '0:0:0:0:0:0:0:1'
      - '{{ hostvars[item].ansible_host }}'
  with_items: '{{ k8s_master_hosts }}'

- name: healthcheck-client
  include_tasks: cert.yml
  vars:
    name: 'healthcheck-client'
    subject: '/O=system:masters, CN=kube-etcd-healthcheck-client'
    dir: '{{ k8s_pki_dir }}/etcd'
    ca_name: '{{ k8s_pki_dir }}/etcd/ca'
    extended_key_usage: 'TLS Web Client Authentication'
