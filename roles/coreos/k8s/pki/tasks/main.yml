- name: create certs directory
  file:
    path: '{{ k8s_pki_dir }}/etcd'
    state: directory
  tags:
    - k8s
    - k8s-pki


- name: Cluster root CA
  include_tasks: ca.yml
  vars:
    name: ca
    cn: kubernetes
    dir: '{{ k8s_pki_dir }}'
  tags:
    - k8s
    - k8s-pki
    - k8s-pki-cluster-ca


- name: Etcd root CA
  include_tasks: ca.yml
  vars:
    name: ca
    cn: kubernetes
    dir: '{{ k8s_pki_dir }}/etcd'
  tags:
    - k8s
    - k8s-pki
    - k8s-pki-etcd-ca


- name: apiserver
  include_tasks: cert.yml
  vars:
    name: apiserver-{{ item }}
    cn: kube-apiserver
    dir: '{{ k8s_pki_dir }}'
    ca_name: '{{ k8s_pki_dir }}/ca'
    extended_key_usage: 'TLS Web Server Authentication'
    alt_dns:
      - 'kubernetes'
      - 'kubernetes.default'
      - 'kubernetes.default.svc'
      - 'kubernetes.default.svc.cluster.local'
      - '{{ k8s_api_fqdn }}'
    alt_ip:
      - '{{ k8s_service_ip }}'
      - '{{ hostvars[item].ansible_host }}'
  with_items: '{{ k8s_master_hosts }}'
  tags:
    - k8s
    - k8s-pki
    - k8s-pki-apiserver


