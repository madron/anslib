- name: root ca
  include_tasks: ca.yml
  vars:
    name: ca
    subject: '/CN=kubernetes'
    dir: '{{ k8s_pki_dir }}'


- name: service account ca
  include_tasks: ca.yml
  vars:
    name: sa
    subject: '/CN=system:kube-controller-manager'
    dir: '{{ k8s_pki_dir }}'


- name: apiserver
  include_tasks: cert.yml
  vars:
    name: 'apiserver-{{ item }}'
    subject: '/CN=kube-apiserver'
    dir: '{{ k8s_pki_dir }}'
    ca_name: '{{ k8s_pki_dir }}/ca'
    extended_key_usage: 'TLS Web Server Authentication'
    alt_dns:
      - 'kubernetes'
      - 'kubernetes.default'
      - 'kubernetes.default.svc'
      - 'kubernetes.default.svc.cluster.local'
      - '{{ k8s_api_fqdn }}'
      - '{{ item }}.{{ k8s_domain }}'
    alt_ip:
      - '{{ k8s_service_ip }}'
      - '{{ hostvars[item].ansible_host }}'
  with_items: '{{ k8s_master_hosts }}'


- name: apiserver-etcd-client
  include_tasks: cert.yml
  vars:
    name: 'apiserver-etcd-client'
    subject: '/O=system:masters, CN=kube-apiserver-etcd-client'
    dir: '{{ k8s_pki_dir }}'
    ca_name: '{{ k8s_pki_dir }}/etcd/ca'
    extended_key_usage: 'TLS Web Client Authentication'


- name: apiserver-kubelet-client
  include_tasks: cert.yml
  vars:
    name: 'apiserver-kubelet-client'
    subject: '/O=system:masters, CN=kube-apiserver-kubelet-client'
    dir: '{{ k8s_pki_dir }}'
    ca_name: '{{ k8s_pki_dir }}/ca'
    extended_key_usage: 'TLS Web Client Authentication'


- name: front proxy ca
  include_tasks: ca.yml
  vars:
    name: front-proxy-ca
    subject: '/CN=kubernetes'
    dir: '{{ k8s_pki_dir }}'


- name: front-proxy-client
  include_tasks: cert.yml
  vars:
    name: 'front-proxy-client'
    subject: '/CN=front-proxy-client'
    dir: '{{ k8s_pki_dir }}'
    ca_name: '{{ k8s_pki_dir }}/front-proxy-ca'
    extended_key_usage: 'TLS Web Client Authentication'
