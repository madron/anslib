- name: required directories
  file:
    path: '{{ item }}'
    state: directory
    owner: root
    group: root
    mode: 0755
  with_items:
    - /etc/kubernetes/manifests
    - /etc/kubernetes/pki/etcd
    - /opt/kubernetes
  tags:
    - k8s
    - k8s-kubelet


#
# Binary
#
- name: binary download
  get_url:
    url: 'https://storage.googleapis.com/kubernetes-release/release/{{ k8s_release }}/bin/linux/amd64/kubelet'
    dest: '/opt/kubernetes/kubelet-{{ k8s_release }}'
    owner: root
    group: root
    mode: 0755
  tags:
    - k8s
    - k8s-kubelet
    - k8s-kubelet-binary


- name: binary symlink
  file:
    src: '/opt/kubernetes/kubelet-{{ k8s_release }}'
    dest: '/opt/bin/kubelet'
    state: link
    owner: root
    group: root
  register: binary
  tags:
    - k8s
    - k8s-kubelet
    - k8s-kubelet-binary


#
# Service
#
- name: fake variables
  set_fact:
    binary: { changed: false }
  tags:
    - k8s-kubelet-service


- name: master variables
  set_fact:
    pki_files:
      - { src: 'ca.crt', dest: 'ca.crt', mode: '0644' }
      - { src: 'apiserver-kubelet-client.key', dest: 'apiserver-kubelet-client.key', mode: '0600' }
      - { src: 'apiserver-kubelet-client.crt', dest: 'apiserver-kubelet-client.crt', mode: '0644' }
  when: k8s_role == 'master'
  tags:
    - k8s
    - k8s-kubelet
    - k8s-kubelet-service


- name: certificates
  copy:
    src: '{{ k8s_pki_dir }}/{{ item.src }}'
    dest: '/etc/kubernetes/pki/{{ item.dest }}'
    owner: root
    group: root
    mode: '{{ item.mode }}'
  register: pki
  with_items: '{{ pki_files }}'
  tags:
    - k8s
    - k8s-kubelet
    - k8s-kubelet-service


- name: /etc/kubernetes/kubelet-kubeconfig.yml
  template:
    src: kubelet-kubeconfig.yml
    dest: /etc/kubernetes/kubelet-kubeconfig.yml
    mode: 0644
    owner: root
    group: root
  register: kubeconfig
  tags:
    - k8s
    - k8s-kubelet
    - k8s-kubelet-service


- name: config /etc/kubernetes/kubelet-config.yml
  template:
    src: kubelet-config.yml
    dest: /etc/kubernetes/kubelet-config.yml
    mode: 0644
    owner: root
    group: root
  register: config
  tags:
    - k8s
    - k8s-kubelet
    - k8s-kubelet-service


- name: /etc/systemd/system/kubelet.service
  template:
    src: kubelet.service
    dest: /etc/systemd/system/kubelet.service
    mode: 0644
    owner: root
    group: root
  register: systemd
  tags:
    - k8s
    - k8s-kubelet
    - k8s-kubelet-service


- name: restart service
  systemd:
    name: kubelet
    state: restarted
    daemon_reload: yes
  when: binary.changed or pki.changed or kubeconfig.changed or config.changed or systemd.changed
  tags:
    - k8s
    - k8s-kubelet
    - k8s-kubelet-service


- name: start service
  systemd:
    name: kubelet
    enabled: yes
    state: started
  tags:
    - k8s
    - k8s-kubelet
    - k8s-kubelet-service
