- name: ssl dir
  file:
    path: /etc/kubernetes/ssl
    state: directory
    owner: root
    group: root
    mode: 0755
  tags:
    - k8s-kubelet

- name: ssl ca cert
  copy:
    src: '{{ k8s_certs_dir }}/ca.pem'
    dest: /etc/kubernetes/ssl/ca.pem
    owner: root
    group: root
    mode: 0644
  tags:
    - k8s-kubelet


- name: /etc/kubernetes/kubeconfig.yml
  template:
    src: kubeconfig.yml
    dest: /etc/kubernetes/kubeconfig.yml
    mode: 0644
    owner: root
    group: root
    backup: yes
  register: config
  tags:
    - k8s-kubelet


- name: /etc/systemd/system/kubelet.service
  template:
    src: kubelet.service
    dest: /etc/systemd/system/kubelet.service
    mode: 0644
    owner: root
    group: root
    backup: yes
  register: systemd
  tags:
    - k8s-kubelet


- name: restart service
  systemd:
    name: kubelet
    state: restarted
    daemon_reload: yes
  when: systemd.changed or config.changed
  tags:
    - k8s-kubelet


- name: start service
  systemd:
    name: kubelet
    enabled: yes
    state: started
  tags:
    - k8s-kubelet
